#!/bin/sh

new_note() {
  set -e

  context="${1:-_inbox}"
  datestamp=$(date +"%Y-%m-%dT%l:%M:%S%z")
  tempfile="$(mktemp -t note).md"

  $EDITOR "$tempfile"

  mkdir -p "$NOTES/$context"
  cat "$tempfile" >> "$NOTES/$context/$datestamp.md"
  rm "$tempfile"
}

find_note() {
  set -e

  pattern="$1"
  if [ -z "$pattern" ]; then
    echo "pattern expected" >&2
    exit 1
  fi

  note=$(ag --nogroup "$pattern" "$NOTES" | sed "s|$NOTES/||" | fzf)
  note_file=$(echo "$note" | cut -d : -f 1)
  note_file_number=$(echo "$note" | cut -d : -f 2)
  $EDITOR "+$note_file_number" "$NOTES/$note_file"
}

edit_notes() {
  cd "$NOTES" > /dev/null
  $EDITOR .
}

case "$1" in
  new)
    new_note "${@:2}"
    ;;
  find)
    find_note "${@:2}"
    ;;
  edit)
    edit_notes
    ;;
  (*)
    echo "command expected" >&2
    exit 1
    ;;
esac
