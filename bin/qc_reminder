#!/usr/bin/env ruby
# 
# qc_reminder
# 
# Created by Gordon Fontenot for WheelsTV
# 
# Scans a set of folders used for Quality Control,
# and if it finds videos, emails the employee responsible
# for that stage of the QC process to let them know they
# have videos ready to QC.


require 'rubygems'
require 'pony'
require 'tinder'

Pony.options = { :from => "production@wheelstv.net", :via => :smtp, :via_options => {
  :address => "smtp.1and1.com",
  :port => "25", 
  :user_name => "production@wheelstv.net", 
  :password => "wheelstv123", 
  :authentication => :plain,
  :domain => "localhost.localdomain", 
  } }

found_files = false

base_dir =  "/Volumes/Exported items/"
product_array = {"1onONE" => "Ryan", "Top200" => "Kipp", "POV" => "Leo", "AutoTrader" => "Nick"}
qc_array = {"1_Technical_" => "George", "2_Creative_" => "Jim", "3_Final Review_" => "Gordon"}
@email_array = {"Gordon" => "gfontenot@wheelstv.net",
  "Nick" => "nbrecken@wheelstv.net",
  "Leo" => "lbonarrigo@wheelstv.net",
  "Kipp" => "kreynolds@wheelstv.net",
  "George" => "gkennedy@wheelstv.net",
  "Ryan" => "rnichols@wheelstv.net",
  "Collin" => "cdavis@wheelstv.net",
  "Jim" => "jimbar@wheelstv.net"}


def notify_user(person, product, count)
  if user_on_campfire? person
    msg_user(person, product, count)
  else
    email_user(person, product, count)
  end
end

def email_user(person, product, count)
  msg = "Hi #{person},\n\nThis is a friendly notification to let you know that you currently have #{count} #{product} videos ready for QC.\n\nThanks,\nThe Management"
  subject = "You have #{count} #{product} videos ready for QC"

  Pony.mail(:to => @email_array[person], :subject => subject, :body => msg)
  
  time_stamp = Time.now.strftime("%D - %r")
  
  puts "#{time_stamp} - Email sent to #{person} (#{count} #{product} videos)"
end

def user_on_campfire? user_name
  campfire = Tinder::Campfire.new 'wheelstv', :token => 'b00ffa07d0e3e9ad47ba809ccad4ee34b51e2e44'
  room = campfire.find_room_by_name "The Office"
  room.users.each do |user|
    if user.name == user_name
      return true
    end
  end
  
  return false
end

def msg_user (person, product, count)
  campfire = Tinder::Campfire.new 'wheelstv', :token => 'b00ffa07d0e3e9ad47ba809ccad4ee34b51e2e44'
  room = campfire.find_room_by_name "The Office"
  room.speak "#{person}: You have #{count} #{product} videos ready for QC"
end


product_array.each_pair do |product, editor|

  qc_dir = File.join(base_dir, product, "/Latest Batch/QC/")
  begin
    count = Dir.entries("#{qc_dir}0_Editor Review_#{editor}").delete_if {|file| /^\./.match(file)}.size
    unless count == 0
      
      notify_user(editor, product, count)
      
      if product == "AutoTrader"
        notify_user("Gordon", product, count)
      end
      
      found_files = true
    end

    qc_array.each_pair do |dir, person|
      count = Dir.entries("#{qc_dir}#{dir}#{person}").delete_if {|file| /^\./.match(file)}.size
      unless count == 0
        # puts "#{person} has #{count} #{product} videos to QC"
        
        notify_user(person, product, count)
        
        found_files = true
      end
    end
  rescue Exception => e
    puts e
  end
end

# unless found_files
#   puts "QC status is clean"
# end
