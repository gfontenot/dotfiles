#!/bin/sh
# Open a PR and copy the url to the clipboard

set -e

msg="$(mktemp -t commitmsg)"

number_of_commits=$(git rev-list master..HEAD --count)
vim_flags=(-c "set ft=gitcommit")

if [ "$number_of_commits" -eq 1 ]; then
  git log -1 --pretty=%B > "$msg"
else
  vim_flags+=(-c startinsert)
  echo > "$msg"
  git log --reverse --format="%h (%aN, %ar)%n%w(78,3,3)%s%n%+b" master..HEAD \
    | sed 's/^/# /' >> "$msg"
fi

vim "${vim_flags[@]}" "$msg"
hub pull-request -m "$(sed '/^#/d' "$msg")" | tr -d '\n' | pbcopy
echo "copied: $(pbpaste)"
